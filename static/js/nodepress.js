(function(f){f.np={};var a=f.np.emitter=f({});var c=f.np.showdown=new Showdown.converter();var h=f.np.tpl={posts:'{{#posts}}<div id="{{id}}" class="np-post"><h2 class="np-post-title">{{title}}</h2><div class="np-post-info np-right"><h4 class="np-post-date">{{published}}</h4></div><div class="np-post-content">{{{content}}}</div><div class="np-post-tags np-right">{{#tags}}<div class="np-post-tag">{{name}}</div>{{/tags}}</div></div>{{/posts}}'};f.np.data={};var e=f.gritter.add;var b,i,d;var k;f.np.init=function(){k=f.np.dom},f.np.setPostId=function(m){b=m};var g={list:function(p,m,o){p=p||0;m=m||5;o=o||[];var n="/_api/list/"+p+"/"+m+"/";if(o.length>0){n+=o.join(",")+"/"}f.ajax({url:n,type:"GET",dataType:"json",success:function(r,q){a.trigger("@ApiList",[r,{skip:p,limit:m,tags:o}])},error:function(r,q){a.trigger("#ApiList",[r,q])}})},save:function(n){var m={};m.title=k.title.attr("value");m.tags=[];f.each(k.tags.attr("value").split(","),function(p,o){if(o){m.tags.push(f.trim(o))}});m.content=k.input.attr("value");if(b){m._id=b}if(n){m.published=1}if(i){m.published=i;m.created=d}f.ajax({url:"/_api/save/",type:"POST",data:JSON.stringify(m),dataType:"json",success:function(o){a.trigger("@ApiSave",[o,n])},error:function(p,o){a.trigger("#ApiSave",[p,o])}})}};f.np.api=g;f.np.signIn=function(){f.ajax({url:"/signin/",type:"POST",dataType:"text",data:{username:k.username.attr("value"),password:k.password.attr("value")},success:function(m){a.trigger("@Login",[m])},error:function(n,m){a.trigger("#Login",[n,m])}})};a.bind("@Login",function(m,n){location.href="/"});a.bind("#Login",function(n,o,m){f.gritter.add({title:"Failed to sign in",time:3000,text:o.responseText})});a.bind("@ApiList",function(o,p,q){var m=f.np.tpl.posts;f.np.data.posts=p;var n=[];f.each(p,function(s,u){var t={};t.id=u._id;if(u.content){t.content=f.np.showdown.makeHtml(u.content)}if(u.title){t.title=u.title}t.published=new Date(parseInt(u.published)).toLocaleDateString();if(u.hasOwnProperty("tags")){t.tags=[];f.each(u.tags,function(w,v){t.tags[w]={name:v}})}n.push(t)});var r=Mustache.to_html(m,{posts:n});k.posts.attr("innerHTML",r);f(".np-post-tag").click(function(s){if(q.tags.indexOf(s.currentTarget.innerHTML)<0){f.merge(q.tags,[s.currentTarget.innerHTML]);a.trigger("TagSelected",[q])}});a.trigger("PostsRendered")});a.bind("@ApiSave",function(n,o,m){b=o._id;e({title:m?"Published successfully":"Saved successfully",text:" "});if(m){g.list();f.np.resetEditor()}});a.bind("TagSelected",l);function l(m,n){g.list(n.skip,n.limit,n.tags);k.filter.attr("innerHTML","");f.each(n.tags,function(p,o){k.filter.prepend('<div class="np-filter-tag">'+o+"</div>")});f("#np-filter div").click(function(p){var o=p.currentTarget.innerHTML;n.tags=f.grep(n.tags,function(q){return o!=q});l(p,n)})}var j;f.np.preview=function(m,o){var n=m.attr("value");n=n===j?false:n;if(n!==false){j=n;o.attr("innerHTML",f.np.showdown.makeHtml(n))}};f.np.resetEditor=function(){k.tabs.click(0);f.each([k.title,k.tags,k.input],function(m,n){n.attr("value","")});k.previewDiv.attr("innerHTML","");b=null};f.np.fillEditor=function(m){f.each(f.np.data.posts,function(n,o){b=m;if(o._id===b){i=o.published;d=o.created;k.title.attr("value",o.title);k.input.attr("value",o.content);k.tags.attr("value",o.tags.join(","))}})}})(jQuery);