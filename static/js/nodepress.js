(function(h){h.np={};var a=h.np.emitter=h({});var d=h.np.showdown=new Showdown.converter();h.np.tpl={posts:'{{#posts}}<div id="{{_id}}" class="np-post"><h2 class="np-post-title"><a href="/article/{{_id}}/{{title}}/">{{title}}</a></h2><div class="np-post-info np-right"><h4 class="np-post-date">{{published}}</h4></div><div class="np-post-content">{{{content}}}</div><div class="np-post-tags np-right">{{#tags}}<div class="np-post-tag">{{name}}</div>{{/tags}}</div></div>{{/posts}}'};h.np.data={};var g=h.gritter.add;var b,j,e,f={},l;h.np.init=function(){l=h.np.dom},h.np.setPostId=function(n){b=n};var i={list:function(r){f=r||f;var q=f.skip||0;var n=f.limit||5;var p=f.tags||[];var o="/_api/blog/list/"+q+"/"+n+"/";if(p.length>0){o+=p.join(",")+"/"}h.ajax({url:o,type:"GET",dataType:"json",success:function(t,s){f={skip:q,limit:n,tags:p};a.trigger("@ApiList",[t,f])},error:function(t,s){a.trigger("#ApiList",[t,s])}})},save:function(o){var n={};n.title=l.title.attr("value");n.tags=[];h.each(l.tags.attr("value").split(","),function(q,p){if(p){n.tags.push(h.trim(p))}});n.content=l.input.attr("value");if(b){n._id=b}if(o){n.published=1}if(j){n.published=j;n.created=e}h.ajax({url:"/_api/blog/save/",type:"POST",data:JSON.stringify(n),dataType:"json",success:function(p){a.trigger("@ApiSave",[p,o])},error:function(q,p){a.trigger("#ApiSave",[q,p])}})},getTracker:function(){h.ajax({url:"/_api/management/tracker/get/",type:"GET",dataType:"text",success:function(n){a.trigger("@ApiGetTracker",[n])},error:function(o,n){a.trigger("#ApiGetTracker",[o,n])}})},saveTracker:function(){h.ajax({url:"/_api/management/tracker/save/",type:"POST",data:l.tracker.attr("value"),dataType:"json",success:function(n){a.trigger("@ApiSaveTracker")},error:function(o,n){a.trigger("#ApiSaveTracker",[o,n])}})}};h.np.api=i;h.np.signIn=function(){h.ajax({url:"/signin/",type:"POST",dataType:"text",data:{username:l.username.attr("value"),password:l.password.attr("value")},success:function(n){a.trigger("@Login",[n])},error:function(o,n){a.trigger("#Login",[o,n])}})};a.bind("@Login",function(n,o){location.href="/"});a.bind("#Login",function(o,p,n){h.gritter.add({title:"Failed to sign in",time:3000,text:p.responseText})});a.bind("@ApiList",function(p,q,r){var n=h.np.tpl.posts;h.np.data.posts=q.posts;var o=[];h.each(q.posts,function(t,v){var u={};u._id=v._id;if(v.content){u.content=h.np.showdown.makeHtml(v.content)}if(v.title){u.title=v.title}u.published=new Date(parseInt(v.published)).toLocaleDateString();if(v.hasOwnProperty("tags")){u.tags=[];h.each(v.tags,function(x,w){u.tags[x]={name:w}})}o.push(u)});var s=Mustache.to_html(n,{posts:o});l.posts.attr("innerHTML",s);h(".np-post-tag").click(function(t){if(r.tags.indexOf(t.currentTarget.innerHTML)<0){h.merge(r.tags,[t.currentTarget.innerHTML]);a.trigger("TagSelected",[r])}});a.trigger("PostsRendered",[q,r])});a.bind("@ApiSave",function(o,p,n){b=p._id;g({title:n?"Published successfully":"Saved successfully",text:" "});if(n){h.np.resetEditor();i.list(f)}});a.bind("TagSelected",m);function m(n,o){i.list({skip:0,limit:5,tags:o.tags});l.filterTags.attr("innerHTML","");h.each(o.tags,function(q,p){l.filterTags.prepend('<div class="np-filter-tag">'+p+"</div>")});h("#np-filter-tags div").click(function(q){var p=q.currentTarget.innerHTML;o.tags=h.grep(o.tags,function(r){return p!=r});m(q,o)})}a.bind("@ApiList",c);function c(o,p,q){var n=p.total;h("#np-post-perpage a").each(function(r,s){s=h(s);var t=parseInt(s.attr("innerHTML"));if(t==q.limit||t-n>10){s.addClass("np-hide")}else{s.unbind("click");s.bind("click",function(){q.limit=t;i.list(q)});s.removeClass("np-hide")}});if(q.skip+q.limit<n){l.nextPage.unbind("click");l.nextPage.bind("click",function(){q.skip+=q.limit;i.list(q)});l.nextPage.removeClass("np-hide")}else{l.nextPage.addClass("np-hide")}if(q.skip>0){l.prevPage.unbind("click");l.prevPage.bind("click",function(){var r=q.skip-q.limit;q.skip=r>0?r:0;i.list(q)});l.prevPage.removeClass("np-hide")}else{l.prevPage.addClass("np-hide")}}h.np.buildPager=c;a.bind("@ApiGetTracker",function(o,n){l.tracker.attr("value",n)});var k;h.np.preview=function(n,p){var o=n.attr("value");o=o===k?false:o;if(o!==false){k=o;p.attr("innerHTML",h.np.showdown.makeHtml(o))}};h.np.resetEditor=function(){h.each([l.title,l.tags,l.input],function(n,o){o.attr("value","")});l.previewDiv.attr("innerHTML","");b=null};h.np.fillEditor=function(n){h.each(h.np.data.posts,function(o,p){b=n;if(p._id===b){j=p.published;e=p.created;l.title.attr("value",p.title);l.input.attr("value",p.content);l.tags.attr("value",p.tags.join(","))}})}})(jQuery);