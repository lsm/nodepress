(function(e){e.np={};var a=e.np.emitter=e({});var c=e.np.showdown=new Showdown.converter();var g=e.np.tpl={posts:'{{#posts}}<div class="np-post"><h2 class="np-post-title">{{title}}</h2><h4 class="np-post-date np-right">{{published}}</h4><div class="np-post-content">{{{content}}}</div><div class="np-post-tags np-right">{{#tags}}<div class="np-post-tag">{{name}}</div>{{/tags}}</div></div>{{/posts}}'};var d=e.gritter.add;var b;var i;e.np.init=function(){i=e.np.dom};var f={list:function(n,k,m){n=n||0;k=k||5;m=m||[];var l="/_api/list/"+n+"/"+k+"/";if(m.length>0){l+=m.join(",")+"/"}e.ajax({url:l,type:"GET",dataType:"json",success:function(p,o){a.trigger("@ApiList",[p,{skip:n,limit:k,tags:m}])},error:function(p,o){a.trigger("#ApiList",[p,o])}})},save:function(l){var k={};k.title=i.title.attr("value");k.tags=[];e.each(i.tags.attr("value").split(","),function(n,m){if(m){k.tags.push(e.trim(m))}});k.content=i.input.attr("value");if(b){k._id=b}if(l){k.published=1}e.ajax({url:"/_api/save/",type:"POST",data:JSON.stringify(k),dataType:"text",success:function(m){a.trigger("@ApiSave",[m,l])},error:function(n,m){a.trigger("#ApiSave",[n,m])}})}};e.np.api=f;e.np.signIn=function(){e.ajax({url:"/signin/",type:"POST",dataType:"text",data:{username:i.username.attr("value"),password:i.password.attr("value")},success:function(k){a.trigger("@Login",[k])},error:function(l,k){a.trigger("#Login",[l,k])}})};a.bind("@Login",function(k,l){location.href="/"});a.bind("#Login",function(l,m,k){e.gritter.add({title:"Failed to sign in",time:3000,text:m.responseText})});a.bind("@ApiList",function(n,o,p){var l=e.np.tpl.posts;var k={posts:e.each(o,function(q,r){if(r.content){r.content=e.np.showdown.makeHtml(r.content)}r.published=new Date(parseInt(r.published)).toLocaleDateString();if(r.hasOwnProperty("tags")){e.each(r.tags,function(t,s){r.tags[t]={name:s}})}})};var m=Mustache.to_html(l,k);e("#np-posts").attr("innerHTML",m);e(".np-post-tag").click(function(q){if(p.tags.indexOf(q.currentTarget.innerHTML)<0){e.merge(p.tags,[q.currentTarget.innerHTML]);a.trigger("TagSelected",[p])}})});a.bind("@ApiSave",function(l,m,k){f.list();b=m;d({title:k?"Published successfully":"Saved successfully",text:" "});k&&e.np.resetEditor()});a.bind("TagSelected",j);function j(k,l){f.list(l.skip,l.limit,l.tags);i.filter.attr("innerHTML","");e.each(l.tags,function(n,m){i.filter.prepend('<div class="np-filter-tag">'+m+"</div>")});e("#np-filter div").click(function(n){var m=n.currentTarget.innerHTML;l.tags=e.grep(l.tags,function(o){return m!=o});j(n,l)})}var h;e.np.preview=function(k,m){var l=k.attr("value");l=l===h?false:l;if(l!==false){h=l;m.attr("innerHTML",e.np.showdown.makeHtml(l))}};e.np.resetEditor=function(){i.tabs.click(0);e.each([i.title,i.tags,i.input],function(k,l){l.attr("value","")});i.previewDiv.attr("innerHTML","");b=null}})(jQuery);