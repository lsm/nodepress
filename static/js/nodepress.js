(function(h){h.np={};var a=h.np.emitter=h({});var d=h.np.showdown=new Showdown.converter();var j=h.np.tpl={posts:'{{#posts}}<div id="{{id}}" class="np-post"><h2 class="np-post-title">{{title}}</h2><div class="np-post-info np-right"><h4 class="np-post-date">{{published}}</h4></div><div class="np-post-content">{{{content}}}</div><div class="np-post-tags np-right">{{#tags}}<div class="np-post-tag">{{name}}</div>{{/tags}}</div></div>{{/posts}}'};h.np.data={};var g=h.gritter.add;var b,k,f,e={},m;h.np.init=function(){m=h.np.dom},h.np.setPostId=function(o){b=o};var i={list:function(s){e=s||e;var r=e.skip||0;var o=e.limit||5;var q=e.tags||[];var p="/_api/list/"+r+"/"+o+"/";if(q.length>0){p+=q.join(",")+"/"}h.ajax({url:p,type:"GET",dataType:"json",success:function(u,t){e={skip:r,limit:o,tags:q};a.trigger("@ApiList",[u,e])},error:function(u,t){a.trigger("#ApiList",[u,t])}})},save:function(p){var o={};o.title=m.title.attr("value");o.tags=[];h.each(m.tags.attr("value").split(","),function(r,q){if(q){o.tags.push(h.trim(q))}});o.content=m.input.attr("value");if(b){o._id=b}if(p){o.published=1}if(k){o.published=k;o.created=f}h.ajax({url:"/_api/save/post/",type:"POST",data:JSON.stringify(o),dataType:"json",success:function(q){a.trigger("@ApiSave",[q,p])},error:function(r,q){a.trigger("#ApiSave",[r,q])}})},getTracker:function(){h.ajax({url:"/_api/get/tracker/",type:"GET",dataType:"text",success:function(o){a.trigger("@ApiGetTracker",[o])},error:function(p,o){a.trigger("#ApiGetTracker",[p,o])}})},saveTracker:function(){h.ajax({url:"/_api/save/tracker/",type:"POST",data:m.tracker.attr("value"),dataType:"json",success:function(o){a.trigger("@ApiSaveTracker")},error:function(p,o){a.trigger("#ApiSaveTracker",[p,o])}})}};h.np.api=i;h.np.signIn=function(){h.ajax({url:"/signin/",type:"POST",dataType:"text",data:{username:m.username.attr("value"),password:m.password.attr("value")},success:function(o){a.trigger("@Login",[o])},error:function(p,o){a.trigger("#Login",[p,o])}})};a.bind("@Login",function(o,p){location.href="/"});a.bind("#Login",function(p,q,o){h.gritter.add({title:"Failed to sign in",time:3000,text:q.responseText})});a.bind("@ApiList",function(q,r,s){var o=h.np.tpl.posts;h.np.data.posts=r.posts;var p=[];h.each(r.posts,function(u,w){var v={};v.id=w._id;if(w.content){v.content=h.np.showdown.makeHtml(w.content)}if(w.title){v.title=w.title}v.published=new Date(parseInt(w.published)).toLocaleDateString();if(w.hasOwnProperty("tags")){v.tags=[];h.each(w.tags,function(y,x){v.tags[y]={name:x}})}p.push(v)});var t=Mustache.to_html(o,{posts:p});m.posts.attr("innerHTML",t);h(".np-post-tag").click(function(u){if(s.tags.indexOf(u.currentTarget.innerHTML)<0){h.merge(s.tags,[u.currentTarget.innerHTML]);a.trigger("TagSelected",[s])}});a.trigger("PostsRendered",[r,s])});a.bind("@ApiSave",function(p,q,o){b=q._id;g({title:o?"Published successfully":"Saved successfully",text:" "});if(o){h.np.resetEditor();i.list(e)}});a.bind("TagSelected",n);function n(o,p){i.list({skip:0,limit:5,tags:p.tags});m.filterTags.attr("innerHTML","");h.each(p.tags,function(r,q){m.filterTags.prepend('<div class="np-filter-tag">'+q+"</div>")});h("#np-filter-tags div").click(function(r){var q=r.currentTarget.innerHTML;p.tags=h.grep(p.tags,function(s){return q!=s});n(r,p)})}a.bind("@ApiList",c);function c(p,q,r){var o=q.total;h("#np-post-perpage a").each(function(s,t){t=h(t);var u=parseInt(t.attr("innerHTML"));if(u==r.limit||u-o>10){t.addClass("np-hide")}else{t.unbind("click");t.bind("click",function(){r.limit=u;i.list(r)});t.removeClass("np-hide")}});if(r.skip+r.limit<o){m.nextPage.unbind("click");m.nextPage.bind("click",function(){r.skip+=r.limit;i.list(r)});m.nextPage.removeClass("np-hide")}else{m.nextPage.addClass("np-hide")}if(r.skip>0){m.prevPage.unbind("click");m.prevPage.bind("click",function(){var s=r.skip-r.limit;r.skip=s>0?s:0;i.list(r)});m.prevPage.removeClass("np-hide")}else{m.prevPage.addClass("np-hide")}}a.bind("@ApiGetTracker",function(p,o){m.tracker.attr("value",o)});var l;h.np.preview=function(o,q){var p=o.attr("value");p=p===l?false:p;if(p!==false){l=p;q.attr("innerHTML",h.np.showdown.makeHtml(p))}};h.np.resetEditor=function(){h.each([m.title,m.tags,m.input],function(o,p){p.attr("value","")});m.previewDiv.attr("innerHTML","");b=null};h.np.fillEditor=function(o){h.each(h.np.data.posts,function(p,q){b=o;if(q._id===b){k=q.published;f=q.created;m.title.attr("value",q.title);m.input.attr("value",q.content);m.tags.attr("value",q.tags.join(","))}})}})(jQuery);